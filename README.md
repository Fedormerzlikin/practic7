# Отчёт по практической работе: Дополнительные возможности Docker

## Цель работы

Изучение дополнительных возможностей Docker для управления жизненным циклом контейнеров, мониторинга их состояния и оптимизации использования системных ресурсов.

---

## Подготовка к работе

### Создание рабочей директории и файлов

Создал директорию для практической работы и необходимые файлы:

```bash
mkdir ~/docker-practice
cd ~/docker-practice
```

**[СКРИНШОТ 1: Создание директории]**

### Создание файла entrypoint.sh

Создал скрипт `entrypoint.sh` со следующим содержимым:

```bash
#!/bin/bash

DURATION=${1:-60}

echo "====== Docker Practice Container ======"
echo "Start time: $(date)"
echo "Duration: ${DURATION} seconds"
echo "========================================"

echo "System Information:"
uname -a
echo "Available Memory: $(free -h | grep Mem)"
echo "CPU Info:"
nproc

counter=0
while [ $counter -lt $DURATION ]; do
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Iteration $((counter + 1))/$DURATION"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Memory usage: $(ps aux | awk '{sum+=$6} END {print sum/1024 " MB"}')"
    sleep 5
    counter=$((counter + 5))
done

echo "====== Container Shutdown ======"
echo "End time: $(date)"
echo "Container completed successfully"
```

**[СКРИНШОТ 2: Содержимое файла entrypoint.sh - команда cat entrypoint.sh]**

### Создание Dockerfile

Создал Dockerfile:

```dockerfile
FROM alpine:3.18

RUN apk add --no-cache \
    bash \
    curl \
    htop \
    procps

RUN addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser

WORKDIR /home/appuser

COPY --chown=appuser:appuser entrypoint.sh /home/appuser/

RUN chmod +x /home/appuser/entrypoint.sh

USER appuser

ENTRYPOINT ["/home/appuser/entrypoint.sh"]

CMD ["60"]
```

**[СКРИНШОТ 3: Содержимое Dockerfile - команда cat Dockerfile]**

### Сборка образа

Выполнил сборку Docker-образа:

```bash
chmod +x entrypoint.sh
docker build -t practice-image:1.0 .
```

**[СКРИНШОТ 4: Процесс сборки образа - вывод docker build]**

Проверил созданный образ:

```bash
docker images
```

**[СКРИНШОТ 5: Список образов - команда docker images с practice-image]**

---

## Задание 1: Вывод логов контейнера в файл

### Описание задания

Запуск контейнера и сохранение его логов в файл для последующего анализа.

### Выполнение

Запустил контейнер на 30 секунд:

```bash
docker run -d --name practice-container-1 practice-image:1.0 30
```

**[СКРИНШОТ 6: Запуск контейнера - команда docker run и docker ps]**

Просмотрел логи контейнера в реальном времени:

```bash
docker logs -f practice-container-1
```

**[СКРИНШОТ 7: Вывод логов контейнера в реальном времени]**

Проверил статус завершения контейнера:

```bash
docker ps -a | grep practice-container-1
```

**[СКРИНШОТ 8: Статус завершенного контейнера (Exited 0)]**

Сохранил логи в файл:

```bash
docker logs practice-container-1 > ~/docker-practice/container_logs.txt
cat ~/docker-practice/container_logs.txt
```

**[СКРИНШОТ 9: Содержимое сохраненных логов]**

Сохранил логи с временными метками:

```bash
docker logs --timestamps practice-container-1 > ~/docker-practice/container_logs_timestamps.txt
```

**[СКРИНШОТ 10: Логи с временными метками]**

Удалил контейнер:

```bash
docker rm practice-container-1
```

### Результат

✅ Успешно сохранены логи контейнера в файлы для дальнейшего анализа

---

## Задание 2: Проверка docker-stats

### Описание задания

Мониторинг потребления системных ресурсов контейнером в реальном времени.

### Выполнение

Запустил контейнер на 45 секунд:

```bash
docker run -d --name practice-container-2 practice-image:1.0 45
```

Просмотрел статистику в реальном времени:

```bash
docker stats practice-container-2
```

**[СКРИНШОТ 11: Статистика контейнера в реальном времени - docker stats]**

Сделал снимок статистики:

```bash
docker stats --no-stream practice-container-2
```

**[СКРИНШОТ 12: Снимок статистики - docker stats --no-stream]**

Сохранил статистику в файл:

```bash
docker stats --no-stream practice-container-2 > ~/docker-practice/stats.txt
cat ~/docker-practice/stats.txt
```

**[СКРИНШОТ 13: Содержимое файла статистики]**

Удалил контейнер после завершения:

```bash
docker rm practice-container-2
```

### Анализ метрик

Наблюдаемые метрики:
- **CPU %**: Процент использования процессорного времени
- **MEM USAGE / LIMIT**: Использование оперативной памяти
- **NET I/O**: Сетевой ввод/вывод
- **BLOCK I/O**: Дисковые операции чтения/записи
- **PIDS**: Количество процессов в контейнере

### Результат

✅ Успешно выполнен мониторинг ресурсов контейнера и сохранены метрики

---

## Задание 3: Ограничение контейнера по CPU и Memory

### Описание задания

Установка ограничений на использование процессора и памяти контейнером.

### Выполнение

Запустил контейнер с ограничениями (256MB памяти, 0.5 CPU):

```bash
docker run -d --name practice-limited \
  --memory=256m \
  --cpus=0.5 \
  practice-image:1.0 60
```

**[СКРИНШОТ 14: Запуск контейнера с ограничениями]**

Проверил статистику с учетом лимитов:

```bash
docker stats --no-stream practice-limited
```

**[СКРИНШОТ 15: Статистика с лимитом 256MiB]**

Обновил лимиты на работающем контейнере:

```bash
docker update --memory=512m --cpus=1.0 practice-limited
```

**[СКРИНШОТ 16: Команда обновления лимитов]**

Проверил обновленные лимиты:

```bash
docker stats --no-stream practice-limited
```

**[СКРИНШОТ 17: Статистика с обновленным лимитом 512MiB]**

Остановил и удалил контейнер:

```bash
docker stop practice-limited
docker rm practice-limited
```

### Результат

✅ Успешно применены и изменены ограничения ресурсов контейнера

---

## Задание 4: Сохранение docker-контейнера в tar

### Описание задания

Экспорт файловой системы контейнера в tar-архив для миграции или архивирования.

### Выполнение

Запустил контейнер:

```bash
docker run -d --name practice-export practice-image:1.0 30
sleep 35
```

**[СКРИНШОТ 18: Запуск контейнера для экспорта]**

Проверил статус контейнера:

```bash
docker ps -a | grep practice-export
```

Экспортировал контейнер в tar-архив:

```bash
docker export practice-export > ~/docker-practice/container_export.tar
```

**[СКРИНШОТ 19: Процесс экспорта контейнера]**

Проверил размер архива:

```bash
ls -lh ~/docker-practice/container_export.tar
```

**[СКРИНШОТ 20: Размер созданного tar-архива]**

Просмотрел содержимое архива:

```bash
tar -tf ~/docker-practice/container_export.tar | head -20
```

**[СКРИНШОТ 21: Содержимое tar-архива]**

Создал сжатый архив:

```bash
docker export practice-export | gzip > ~/docker-practice/container_export.tar.gz
ls -lh ~/docker-practice/container_export.tar*
```

**[СКРИНШОТ 22: Сравнение размеров обычного и сжатого архива]**

Удалил контейнер:

```bash
docker rm practice-export
```

### Результат

✅ Успешно экспортирован контейнер в tar-архив (обычный и сжатый)

---

## Задание 5: Загрузка контейнера из tar

### Описание задания

Импорт образа из tar-архива и запуск контейнера из восстановленного образа.

### Выполнение

Импортировал образ из tar-архива:

```bash
docker import ~/docker-practice/container_export.tar restored-practice:1.0
```

**[СКРИНШОТ 23: Процесс импорта образа из tar]**

Проверил созданный образ:

```bash
docker images | grep restored
```

**[СКРИНШОТ 24: Восстановленный образ в списке]**

Запустил контейнер из восстановленного образа:

```bash
docker run -d --name restored-from-tar restored-practice:1.0 /home/appuser/entrypoint.sh 30
```

**[СКРИНШОТ 25: Запуск контейнера из восстановленного образа]**

Проверил работу контейнера:

```bash
docker ps | grep restored
```

Просмотрел логи восстановленного контейнера:

```bash
sleep 35
docker logs restored-from-tar
```

**[СКРИНШОТ 26: Логи восстановленного контейнера]**

Очистка:

```bash
docker rm restored-from-tar
docker rmi restored-practice:1.0
```

**[СКРИНШОТ 27: Удаление контейнера и образа]**

### Результат

✅ Успешно импортирован образ из tar-архива и запущен контейнер

---

## Итоговая проверка выполненной работы

Просмотрел все созданные файлы:

```bash
ls -lh ~/docker-practice/
```

**[СКРИНШОТ 28: Список всех созданных файлов]**

Проверил финальное состояние Docker:

```bash
docker ps -a
docker images
```

**[СКРИНШОТ 29: Финальное состояние контейнеров и образов]**

---

## Ответы на контрольные вопросы

### 1. Какие потоки данных перехватывает Docker при логировании и почему это важно для диагностики?

Docker перехватывает стандартные потоки вывода **stdout** (стандартный вывод) и **stderr** (поток ошибок) контейнеризированного приложения. Это важно для диагностики, так как позволяет:
- Восстановить цепь событий при сбоях
- Провести постмортем-анализ проблем
- Отследить все сообщения и ошибки приложения
- Интегрировать логи с внешними системами мониторинга

### 2. Каким образом контрольные группы (cgroups) Linux обеспечивают ограничение ресурсов в Docker?

Контрольные группы (cgroups) работают на уровне ядра Linux и позволяют:
- Отслеживать потребление ресурсов отдельными процессами
- Устанавливать жесткие лимиты на память (hard limit)
- Применять throttling для процессора при превышении лимитов
- Завершать процессы через OOM-killer при исчерпании памяти
- Обеспечивать изоляцию и справедливое распределение ресурсов

### 3. Чем отличается экспорт контейнера от сохранения образа, и в каких сценариях применяется каждый подход?

**Экспорт контейнера (docker export)**:
- Сохраняет файловую систему контейнера в текущем состоянии
- Теряется история слоев образа
- Не сохраняются метаданные (ENTRYPOINT, CMD)
- Используется для миграции настроенных контейнеров

**Сохранение образа (docker save)**:
- Сохраняет образ со всеми слоями и историей
- Сохраняются все метаданные
- Используется для распространения образов

### 4. Почему важно устанавливать ограничения памяти для контейнеров в многоконтейнерной среде?

Ограничения памяти важны для:
- **Предотвращения "noisy neighbor"**: один контейнер не может монополизировать ресурсы
- **Защиты от DoS**: предотвращение полного исчерпания памяти хоста
- **Справедливого распределения**: обеспечение QoS для всех контейнеров
- **Предсказуемости**: гарантированное поведение приложений
- **Безопасности**: изоляция приложений друг от друга

### 5. Какие метрики предоставляет docker stats и как их интерпретировать для оптимизации производительности?

**Метрики docker stats**:
- **CPU %**: использование процессорного времени (высокие значения = нужно больше CPU или оптимизация кода)
- **MEM USAGE / LIMIT**: потребление памяти (рост со временем = утечка памяти)
- **NET I/O**: сетевой трафик (высокие значения = много сетевых операций)
- **BLOCK I/O**: дисковые операции (высокие значения = оптимизировать работу с диском)
- **PIDS**: количество процессов (много процессов = возможно избыточное распараллеливание)

### 6. Как восстановить контейнер из tar-архива и какие ограничения существуют при этом процессе?

**Процесс восстановления**:
```bash
docker import archive.tar image-name:tag
docker run -d --name container image-name command
```

**Ограничения**:
- Теряется история слоев образа
- Не сохраняются ENTRYPOINT и CMD
- Нужно явно указывать команду запуска
- Нет информации о порте и томах из оригинального образа

### 7. Каким образом можно использовать экспорт контейнеров для миграции приложений между хостами?

**Процесс миграции**:
1. Экспорт на исходном хосте: `docker export container > app.tar`
2. Передача архива на целевой хост (scp, rsync)
3. Импорт на целевом хосте: `docker import app.tar app:1.0`
4. Запуск контейнера с нужными параметрами

**Преимущества**:
- Портативность между различными хостами и облаками
- Простота переноса настроенных окружений
- Возможность создания резервных копий

---

## Выводы

В ходе практической работы были изучены и успешно применены следующие возможности Docker:

1. ✅ **Логирование**: Освоены методы захвата и сохранения логов контейнеров для диагностики и аудита
2. ✅ **Мониторинг**: Использована команда `docker stats` для анализа потребления ресурсов
3. ✅ **Ограничение ресурсов**: Применены лимиты CPU и памяти для обеспечения справедливого распределения ресурсов
4. ✅ **Экспорт/Импорт**: Выполнена миграция контейнеров через tar-архивы

Все задания выполнены успешно. Полученные навыки критически важны для построения надежных и масштабируемых приложений в production-среде.

---

## Список использованных команд

```bash
# Сборка образа
docker build -t practice-image:1.0 .

# Работа с логами
docker logs container_name
docker logs --timestamps container_name
docker logs -f container_name

# Мониторинг
docker stats container_name
docker stats --no-stream container_name

# Ограничение ресурсов
docker run --memory=256m --cpus=0.5 image_name
docker update --memory=512m container_name

# Экспорт/Импорт
docker export container_name > archive.tar
docker import archive.tar image_name:tag

# Управление контейнерами
docker ps -a
docker rm container_name
docker rmi image_name
```

---

**Практическая работа выполнена:** [Дата]  
**Выполнил:** [Ваше имя]  
**Группа:** [Номер группы]
